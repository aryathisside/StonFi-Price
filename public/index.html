<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STON.fi Price Fetcher - SDK Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .status-value.online {
            color: #27ae60;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e0e6ed;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 18px;
        }

        .filters-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
            min-width: 120px;
        }

        .filter-select:focus, .filter-input:focus {
            border-color: #667eea;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .performance-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f4fd 0%, #f8f9fa 100%);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .perf-item {
            text-align: center;
        }

        .perf-label {
            color: #7f8c8d;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .perf-value {
            color: #2c3e50;
            font-weight: 600;
            margin-top: 2px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pairs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .pair-card {
            background: white;
            border: 2px solid #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pair-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pair-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .pair-price {
            font-size: 1.4rem;
            font-weight: 800;
            color: #27ae60;
            text-align: right;
        }

        .pair-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .copy-indicator {
            position: absolute;
            top: -30px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .copy-indicator.show {
            opacity: 1;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 0 15px;
        }

        .pagination-btn {
            background: white;
            border: 2px solid #e0e6ed;
            color: #667eea;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .error, .success, .info {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
        }

        .success {
            background: #efe;
            border: 2px solid #cfc;
            color: #3c3;
        }

        .info {
            background: #e8f4fd;
            border: 2px solid #bee5eb;
            color: #0c5460;
        }

        .no-results {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1rem;
            margin: 40px 0;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .swap-section {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
        }

        .swap-form {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: #667eea;
        }

        .swap-arrow {
            font-size: 2rem;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                justify-content: center;
            }
            
            .pairs-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 15px;
            }

            .swap-form {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .swap-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> STON.fi Price Fetcher</h1>
            <p>Real-time trading pairs using official STON.fi SDK</p>
        </div>

        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <div class="status-label">Server Status</div>
                <div class="status-value" id="serverStatus">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Total Pairs</div>
                <div class="status-value" id="totalPairs">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Showing</div>
                <div class="status-value" id="filteredPairs">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Last Updated</div>
                <div class="status-value" id="lastUpdated">-</div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Search trading pairs... (e.g., TON, USDT, USD)"
                >
                <div class="search-icon">🔍</div>
            </div>

            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select id="categoryFilter" class="filter-select">
                        <option value="all">All Pairs</option>
                        <option value="stablecoins">Stablecoins</option>
                        <option value="meme">Meme Coins</option>
                        <option value="defi">DeFi Tokens</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select id="sortByFilter" class="filter-select">
                        <option value="liquidity">Liquidity</option>
                        <option value="volume">24h Volume</option>
                        <option value="apy">APY</option>
                        <option value="price">Price</option>
                        <option value="name">Name</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Order</label>
                    <select id="sortOrderFilter" class="filter-select">
                        <option value="desc">High to Low</option>
                        <option value="asc">Low to High</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Min Liquidity</label>
                    <input type="number" id="minLiquidityFilter" class="filter-input" placeholder="0" min="0" step="1000">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Per Page</label>
                    <select id="limitFilter" class="filter-select">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="fetchBtn" onclick="fetchPairs()">
                    Load Pairs
                </button>
                <button class="btn" id="refreshBtn" onclick="refreshPairs()" style="display: none;">
                    Refresh
                </button>
                <button class="btn secondary" onclick="resetFilters()">
                    Reset Filters
                </button>
                <button class="btn secondary" onclick="checkHealth()">
                    Check Server
                </button>
            </div>
        </div>

        <div class="performance-stats" id="performanceStats" style="display: none;">
            <div class="perf-item">
                <div class="perf-label">Load Time</div>
                <div class="perf-value" id="loadTime">-</div>
            </div>
            <div class="perf-item">
                <div class="perf-label">Filtered</div>
                <div class="perf-value" id="filteredCount">-</div>
            </div>
            <div class="perf-item">
                <div class="perf-label">Total</div>
                <div class="perf-value" id="totalCount">-</div>
            </div>
            <div class="perf-item">
                <div class="perf-label">Page</div>
                <div class="perf-value" id="currentPageInfo">-</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span id="loadingText">Loading trading pairs...</span>
        </div>

        <div id="messages"></div>
        
        <div id="pairsContainer" class="pairs-grid"></div>

        <div class="pagination" id="paginationContainer" style="display: none;">
            <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)">⏮️ First</button>
            <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">⬅️ Prev</button>
            
            <div id="pageNumbers" style="display: flex; gap: 5px;"></div>
            
            <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">Next ➡️</button>
            <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(totalPages)">Last ⏭️</button>
            
            <div class="pagination-info" id="paginationInfo">-</div>
        </div>
        
        <div id="noResults" class="no-results" style="display: none;">
            No trading pairs found matching your search criteria.
        </div>

        <div class="swap-section" id="swapSection" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">🔄 Simulate Swap</h3>
            <div class="swap-form">
                <div class="form-group">
                    <label class="form-label">From Token Address</label>
                    <input type="text" id="tokenAAddress" class="form-input" placeholder="EQ...">
                </div>
                <div class="swap-arrow">→</div>
                <div class="form-group">
                    <label class="form-label">To Token Address</label>
                    <input type="text" id="tokenBAddress" class="form-input" placeholder="EQ...">
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: end;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Amount</label>
                    <input type="number" id="amountIn" class="form-input" placeholder="1000">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Slippage %</label>
                    <input type="number" id="slippage" class="form-input" placeholder="0.1" value="0.1" step="0.1">
                </div>
                <button class="btn" onclick="simulateSwap()">Simulate Swap</button>
            </div>
            <div id="swapResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        let allPairs = [];
        let currentPage = 1;
        let totalPages = 1;
        let totalItems = 0;
        let currentFilters = {};
        const API_BASE = '';

        // Check server health on load
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Search input with debounce
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1; // Reset to first page on search
                    fetchPairs();
                }, 500);
            });

            // Filter change listeners
            ['categoryFilter', 'sortByFilter', 'sortOrderFilter', 'limitFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    currentPage = 1; // Reset to first page on filter change
                    fetchPairs();
                });
            });

            // Min liquidity with debounce
            let liquidityTimeout;
            document.getElementById('minLiquidityFilter').addEventListener('input', () => {
                clearTimeout(liquidityTimeout);
                liquidityTimeout = setTimeout(() => {
                    currentPage = 1;
                    fetchPairs();
                }, 1000);
            });
        }

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('serverStatus').textContent = 'Online';
                    document.getElementById('serverStatus').classList.add('online');
                    
                    if (data.cache.hasPairs) {
                        document.getElementById('totalPairs').textContent = data.cache.pairCount;
                        if (data.cache.lastUpdated) {
                            updateTimestamp(data.cache.lastUpdated);
                        }
                    }
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                document.getElementById('serverStatus').textContent = 'Offline';
                document.getElementById('serverStatus').style.color = '#e74c3c';
                showMessage('error', 'Server is not responding. Please make sure the Node.js server is running.');
            }
        }

        async function fetchPairs() {
            const startTime = Date.now();
            const loading = document.getElementById('loading');
            const fetchBtn = document.getElementById('fetchBtn');
            const refreshBtn = document.getElementById('refreshBtn');

            loading.style.display = 'block';
            document.getElementById('loadingText').textContent = 'Loading trading pairs...';
            fetchBtn.disabled = true;
            clearMessages();

            try {
                // Get current filter values
                const filters = {
                    page: currentPage,
                    limit: parseInt(document.getElementById('limitFilter').value),
                    search: document.getElementById('searchInput').value.trim(),
                    category: document.getElementById('categoryFilter').value,
                    sortBy: document.getElementById('sortByFilter').value,
                    sortOrder: document.getElementById('sortOrderFilter').value,
                    minLiquidity: parseFloat(document.getElementById('minLiquidityFilter').value) || 0
                };

                currentFilters = filters;

                // Build query string
                const queryParams = new URLSearchParams(filters);
                const response = await fetch(`/api/pairs?${queryParams}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch pairs');
                }

                // Update data
                allPairs = result.data;
                totalPages = result.pagination.totalPages;
                totalItems = result.pagination.totalItems;
                currentPage = result.pagination.currentPage;

                // Update UI
                displayPairs(allPairs);
                updatePagination(result.pagination);
                updateStats(result.pagination);
                updateTimestamp(result.lastUpdated);
                
                // Show performance stats
                const loadTime = Date.now() - startTime;
                updatePerformanceStats(loadTime, result.pagination);
                
                refreshBtn.style.display = 'inline-block';
                document.getElementById('swapSection').style.display = 'block';
                
                const cacheStatus = result.cached ? ' (cached)' : ' (fresh)';
                showMessage('success', `Loaded ${allPairs.length} pairs (page ${currentPage}/${totalPages})${cacheStatus}`);

            } catch (error) {
                console.error('Error fetching pairs:', error);
                showMessage('error', `Error: ${error.message}`);
            } finally {
                loading.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }

        function displayPairs(pairs) {
            const container = document.getElementById('pairsContainer');
            const noResults = document.getElementById('noResults');
            
            if (pairs.length === 0) {
                container.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            container.innerHTML = pairs.map(pair => `
                <div class="pair-card" onclick="selectPair('${pair.poolAddress}', '${pair.name}', '${pair.formattedPrice}')">
                    <div class="copy-indicator" id="copy-${pair.poolAddress}">Copied!</div>
                    <div class="pair-header">
                        <div class="pair-name">${pair.name}</div>
                        <div class="pair-price">${pair.formattedPrice}</div>
                    </div>
                    <div class="pair-details">
                        <div class="detail-item">
                            <div class="detail-label">Liquidity</div>
                            <div class="detail-value">$${formatNumber(pair.liquidity)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">24h Volume</div>
                            <div class="detail-value">$${formatNumber(pair.volume24h)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">APY</div>
                            <div class="detail-value">${pair.apy.toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pool Address</div>
                            <div class="detail-value" style="font-size: 0.8rem; word-break: break-all;">
                                ${pair.poolAddress.substring(0, 8)}...${pair.poolAddress.substring(pair.poolAddress.length - 6)}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e6ed;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #7f8c8d;">
                            <span>Token0: ${pair.token0.symbol}</span>
                            <span>Token1: ${pair.token1.symbol}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #95a5a6; margin-top: 5px;">
                            <span>$${pair.token0.usdPrice ? pair.token0.usdPrice.toFixed(4) : 'N/A'}</span>
                            <span>$${pair.token1.usdPrice ? pair.token1.usdPrice.toFixed(4) : 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePagination(pagination) {
            const container = document.getElementById('paginationContainer');
            const pageNumbers = document.getElementById('pageNumbers');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (pagination.totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            
            // Update navigation buttons
            document.getElementById('firstPageBtn').disabled = !pagination.hasPrevPage;
            document.getElementById('prevPageBtn').disabled = !pagination.hasPrevPage;
            document.getElementById('nextPageBtn').disabled = !pagination.hasNextPage;
            document.getElementById('lastPageBtn').disabled = !pagination.hasNextPage;
            
            // Generate page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, pagination.currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(pagination.totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            let pageNumbersHTML = '';
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersHTML += `
                    <button class="pagination-btn ${i === pagination.currentPage ? 'active' : ''}" 
                            onclick="goToPage(${i})">${i}</button>
                `;
            }
            pageNumbers.innerHTML = pageNumbersHTML;
            
            // Update info
            paginationInfo.textContent = `${pagination.startIndex}-${pagination.endIndex} of ${pagination.totalItems} pairs`;
        }

        function updateStats(pagination) {
            document.getElementById('totalPairs').textContent = pagination.totalItems;
            document.getElementById('filteredPairs').textContent = pagination.totalItems;
        }

        function updatePerformanceStats(loadTime, pagination) {
            document.getElementById('loadTime').textContent = `${loadTime}ms`;
            document.getElementById('filteredCount').textContent = pagination.totalItems;
            document.getElementById('totalCount').textContent = pagination.totalItems;
            document.getElementById('currentPageInfo').textContent = `${pagination.currentPage}/${pagination.totalPages}`;
            document.getElementById('performanceStats').style.display = 'flex';
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                fetchPairs();
            }
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('sortByFilter').value = 'liquidity';
            document.getElementById('sortOrderFilter').value = 'desc';
            document.getElementById('minLiquidityFilter').value = '';
            document.getElementById('limitFilter').value = '50';
            currentPage = 1;
            fetchPairs();
        }

        async function refreshPairs() {
            await fetchPairs();
        }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        function updateTimestamp(timestamp) {
            if (timestamp) {
                const date = new Date(timestamp);
                document.getElementById('lastUpdated').textContent = date.toLocaleTimeString();
            }
        }

        function selectPair(poolAddress, pairName, price) {
            // Copy pool address to clipboard
            navigator.clipboard.writeText(poolAddress).then(() => {
                // Show copy indicator
                const indicator = document.getElementById(`copy-${poolAddress}`);
                if (indicator) {
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }
                
                showMessage('info', `Selected: ${pairName} | Price: ${price} | Pool address copied to clipboard`);
                
                // Auto-fill swap form if visible
                const swapSection = document.getElementById('swapSection');
                if (swapSection.style.display !== 'none') {
                    const pair = allPairs.find(p => p.poolAddress === poolAddress);
                    if (pair) {
                        document.getElementById('tokenAAddress').value = pair.token0.address;
                        document.getElementById('tokenBAddress').value = pair.token1.address;
                    }
                }
                
            }).catch(err => {
                showMessage('error', 'Failed to copy to clipboard');
            });
        }

        async function simulateSwap() {
            const tokenAAddress = document.getElementById('tokenAAddress').value.trim();
            const tokenBAddress = document.getElementById('tokenBAddress').value.trim();
            const amountIn = document.getElementById('amountIn').value.trim();
            const slippage = document.getElementById('slippage').value.trim();

            if (!tokenAAddress || !tokenBAddress || !amountIn) {
                showMessage('error', 'Please fill in all required fields for swap simulation');
                return;
            }

            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            document.getElementById('loadingText').textContent = 'Simulating swap...';

            try {
                const response = await fetch('/api/simulate-swap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tokenAAddress,
                        tokenBAddress,
                        amountIn,
                        slippageTolerance: (parseFloat(slippage) / 100).toString()
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Swap simulation failed');
                }

                // Display swap result
                const swapResult = document.getElementById('swapResult');
                swapResult.innerHTML = `
                    <div class="success">
                        <h4>Swap Simulation Result</h4>
                        <pre style="margin-top: 10px; text-align: left; white-space: pre-wrap;">${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                console.error('Error simulating swap:', error);
                document.getElementById('swapResult').innerHTML = `
                    <div class="error">
                        <strong>Swap Simulation Failed:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        function showMessage(type, message) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            messagesContainer.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Auto-refresh every 2 minutes when user is inactive
        setInterval(() => {
            if (allPairs.length > 0) {
                checkHealth();
                // Only auto-refresh if user hasn't interacted recently
                const lastActivity = localStorage.getItem('lastActivity');
                const now = Date.now();
                if (!lastActivity || (now - parseInt(lastActivity)) > 120000) { // 2 minutes
                    refreshPairs();
                }
            }
        }, 120000);

        // Track user activity
        ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
            document.addEventListener(event, () => {
                localStorage.setItem('lastActivity', Date.now().toString());
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshPairs();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                }
            }
        });
    </script>
</body>
</html>